# 融云红包集成文档


## 1. redpacketlibrary简介

**redpacketlibrary**，在融云**sdk2.5.2**的基础上提供了收发红包和零钱页的功能。


## 2. redpacketlibrary目录说明

* libs ：redpacket2.0.jar是集成红包功能所依赖的jar包。
* res ：包含了红包SDK和聊天页面中的资源文件。（红包SDK相关以rp开头）
* callback ：此接口只有群/讨论组红包用到
* 1、GetGroupInfoCallback 获取群/讨论组里面的人数（app开发者需要自己处理）的接口回调。
* 2、ToRedPacketActivity 打开发红包界面接口回调
* message ：
* 1、RongRedPacketMessage 自定义红包消息。
* 2、RongNotificationMessage 自定义通知消息，用于领取了红包之后，回执消息发给红包者
* 3、RongEmptyMessage 自定义空消息，**用于群/讨论组领取了红包之后，1、接受者先向本地插入一条“你领取了XX的红包”，然后发送一条空消息（不在聊天界面展示），发送红包者收到消息之后，向本地插入一条“XX领取了你的红包”，2、如果接受者和发送者是一个人就直接向本地插入一条“你领取了自己的红包”**
*  provider ：
*  1、RongRedPacketProvider 扩展栏单聊红包提供者
*  2、RongRedPacketMessageProvider 红包消息UI展示提供者
*  3、RongNotificationMessageProvider 回执消息UI展示提供者
*  4、RongGroupRedPacketProvider 扩展栏群聊/讨论组红包提供者
* RPContext.java 封装了融云消息类型和模板注册以及插入消息的方法。
* **注意: redpacketlibrary依赖了IMKIT，可以查看redpacketlibrary的build.gradle**。

## 3. 集成步骤

###3.1 添加对红包工程的依赖
* RongDemo的build.gradle中

```
    compile fileTree(include: ['*.jar'], dir: 'src/main/libs')
    compile 'com.android.support:appcompat-v7:21.0.3'
    compile files('src/main/libs/ TencentLocationSDK_v4.4.6_r206631_151119_1441.jar')
    compile files('src/main/libs/TencentMapSDK_Raster_v1.1.2.16281.jar')
    compile project(':redpacketlibrary')

```

* RongDemo的setting.gradle中

```
include ':IMKit',':app',':redpacketlibrary'

```
###3.2 RongDemo清单文件中注册红包相关组件

```

       <uses-sdk
           android:minSdkVersion="9"
           android:targetSdkVersion="21"
           tools:overrideLibrary="com.easemob.redpacketui"/>
        
        <!--红包相关界面 start-->
        <activity
            android:name="com.easemob.redpacketui.ui.activity.RPRedPacketActivity"
            android:screenOrientation="portrait"
            android:theme="@style/horizontal_slide"
            android:windowSoftInputMode="adjustPan|stateVisible"
            />
        <activity
            android:name="com.easemob.redpacketui.ui.activity.RPDetailActivity"
            android:screenOrientation="portrait"
            android:theme="@style/horizontal_slide"
            android:windowSoftInputMode="adjustPan"
            />

        <activity
            android:name="com.easemob.redpacketui.ui.activity.RPRecordActivity"
            android:screenOrientation="portrait"
            android:theme="@style/horizontal_slide"
            android:windowSoftInputMode="adjustPan"
            />

        <activity
            android:name="com.easemob.redpacketui.ui.activity.RPWebViewActivity"
            android:screenOrientation="portrait"
            android:theme="@style/horizontal_slide"
            android:windowSoftInputMode="adjustResize|stateHidden"
            />
        <activity
            android:name="com.easemob.redpacketui.ui.activity.RPChangeActivity"
            android:screenOrientation="portrait"
            android:theme="@style/horizontal_slide"
            android:windowSoftInputMode="adjustResize|stateHidden"
            />
        <activity
            android:name="com.easemob.redpacketui.ui.activity.RPBankCardActivity"
            android:screenOrientation="portrait"
            android:theme="@style/horizontal_slide"
            android:windowSoftInputMode="adjustPan|stateHidden"
            />
        <!--红包相关界面 end-->
             
```

###3.3 初始化红包上下文和注册融云自定义消息类型和模板

* App中初始化红包上下文和注册红包消息、回执消息类以及消息展示模板。

```
   import com.easemob.redpacketsdk.RedPacket;
   import com.easemob.redpacketui.RPContext; 
    
    @Override
    public void onCreate() {
        super.onCreate();
        /**
         * 注意：
         *
         * IMKit SDK调用第一步 初始化
         *
         * context上下文
         *
         * 只有两个进程需要初始化，主进程和 push 进程
         */
    if (getApplicationInfo().packageName.equals(getCurProcessName(getApplicationContext())) ||
              "io.rong.push".equals(getCurProcessName(getApplicationContext()))) {

            RongIM.init(this);

           /**
            * 融云SDK事件监听处理
            *
            * 注册相关代码，只需要在主进程里做。
            */
           if (getApplicationInfo().packageName.equals(getCurProcessName(getApplicationContext()))) {

               RongCloudEvent.init(this);
               DemoContext.init(this);

               Thread.setDefaultUncaughtExceptionHandler(new RongExceptionHandler(this));

               try {
                 //注册红包消息、回执消息类以及消息展示模板
                 RPContext.getInstance().registerMsgTypeAndTemplate(this);
                    
                 RongIM.registerMessageType(AgreedFriendRequestMessage.class);
                 RongIM.registerMessageTemplate(new ContactNotificationMessageProvider());
                 RongIM.registerMessageTemplate(new RealTimeLocationMessageProvider());
                 //@ 消息模板展示
                 RongContext.getInstance().registerConversationTemplate(new NewDiscussionConversationProvider());

                } catch (Exception e) {
                    e.printStackTrace();
                }
            }
        }
        //初始化红包上下文
        RedPacket.getInstance().initContext(this);

    }
```
* RongCloudEvent实现OnReceiveMessageListener。

```

    /**
     * RongIM.init(this) 后直接可注册的Listener。
     */
    private void initDefaultListener() {
    
        RongIM.getInstance().getRongIMClient().setOnReceiveMessageListener(this);//设置消息接收监听器。
       
    }
    
    /**
     * 接收消息的监听器：OnReceiveMessageListener 的回调方法，接收到消息后执行。
     *
     * @param message 接收到的消息的实体信息。
     * @param left    剩余未拉取消息数目。
     */
    @Override
    public boolean onReceived(Message message, int left) {

        MessageContent messageContent = message.getContent();
       if (messageContent instanceof RongEmptyMessage) {
            Log.e(TAG, "--onReceived--空消息");
            //接收到空消息（不展示UI的消息）向本地插入一条“XX领取了你的红包”
            RPContext.getInstance().insertMessage(message);
        } else {
            Log.d(TAG, "onReceived-其他消息，自己来判断处理");
        }
        return false;

    }
```
###3.4 初始化红包Token和用户信息
*LoginActivity获取我的群组信息成功后请求签名（商户号和密钥请联系云账户获取、签名需要在自己服务器获取）并初始化红包token

```
    import com.easemob.redpacketsdk.RPCallback;
    import com.easemob.redpacketsdk.RedPacket;
    
    /**
     * 获得自己所加入得群组成功以后，调用 syncGroup 方法，同步自己所加入得群组
     *
     * @param obj
     */
     private void getMyGroupApiSuccess(Object obj) {
        if (obj instanceof Groups) {
           ...
               //请求签名然后初始化红包Token
               RequestTask requestTask = new RequestTask();
               requestTask.execute();
           ...
        }
    } 
    //此异步任务请求签名只是示例（App开发者需要去自己服务器请求签名参数，然后初始化红包Token）   
    public class RequestTask extends AsyncTask<String, String, String> {

     @Override
     protected String doInBackground(String... uri) {
     String userID = DemoContext.getInstance().getSharedPreferences().getString(Constants.APP_USER_ID, 
                     Constants.DEFAULT);
           //需要替换成自己的URL
           String mockUrl = "http://rpv2.easemob.com/api/sign?duid=" + userID;
           HttpClient client = new DefaultHttpClient();
           HttpGet request = new HttpGet(mockUrl);
           // replace with your url
           HttpResponse response;
           try {
                response = client.execute(request);
                if (response.getStatusLine().getStatusCode() == 200) {
                    Log.d("Response of GET request", response.toString());
                    String responseBody = EntityUtils.toString(response.getEntity());
                    return responseBody;
                }
                return null;
            } catch (ClientProtocolException e) {
                // TODO Auto-generated catch block
                Log.e(TAG, e.getMessage());
            } catch (Exception e) {
                // TODO Auto-generated catch block
                Log.e(TAG, e.getMessage());
            }
            return null;

        }

        @Override
        protected void onPostExecute(String result) {
            try {
                if (result != null) {
                    JSONObject jsonObj = new JSONObject(result);
                    String partner = jsonObj.getString("partner");
                    String userId = jsonObj.getString("user_id");
                    String timestamp = jsonObj.getString("timestamp");
                    String sign = jsonObj.getString("sign");
                    //初始化红包Token  
                    /**
                      * @param partner      商户代码 (联系云账户后端获取)
                      * @param userId       商户用户id
                      * @param timestamp    签名使用的时间戳
                      * @param sign         签名 
                      * @param callback  处理结果的回调方法
                      * 方法中所涉及到的参数均由AppServer提供，AppServer所采用的签名方法由云账户提供。
                     */                   
                      RedPacket.getInstance().initRPAuthToken(partner, userId, timestamp, sign,new RPCallback() {
                           @Override
                           public void onSuccess() {
                            // 进入主页面
                            mHandler.obtainMessage(HANDLER_LOGIN_SUCCESS).sendToTarget();
                            Log.e(TAG, "init luck money success token: " + RedPacket.getInstance().sToken);
                             }

                            @Override
                            public void onError(String code, String message) {
                            //错误处理
                            mHandler.obtainMessage(HANDLER_LOGIN_FAILURE).sendToTarget();
                            Log.e(TAG, "init luck money fail token:" + message);

                             }
                     }); 
                     
                } else {
                    mHandler.obtainMessage(HANDLER_LOGIN_FAILURE).sendToTarget();
                }

            } catch (Exception e) {
                e.printStackTrace();
            }
        }

    }    
```
* LoginActivity登录时初始化用户信息。

```
    import com.easemob.redpacketui.RPContext;
        
    /**
     * 以下是demo 的逻辑，与sdk 没有关系。
     * 1，登录成功，获得 cookie 和 token
     *
     * @param obj
     */
    private void loginApiSuccess(Object obj) {
        if (obj instanceof User) {
            final User user = (User) obj;
            if (user.getCode() == 200) {
                if (DemoContext.getInstance() != null && user.getResult() != null) {
                    //获得token，通过token 去做 connect 操作
                    httpGetTokenSuccess(user.getResult().getToken());

                    SharedPreferences.Editor edit = DemoContext.getInstance().getSharedPreferences().edit();
                    edit.putString(Constants.APP_USER_NAME, user.getResult().getUsername());
                    edit.putString(Constants.APP_USER_PORTRAIT, user.getResult().getPortrait());
                    edit.putString(Constants.APP_TOKEN, user.getResult().getToken());
                    edit.putString(INTENT_PASSWORD, mPassWordEt.getText().toString());
                    edit.putString(INTENT_IMAIL, mUserNameEt.getText().toString());
                    edit.putBoolean("DEMO_ISFIRST", false);
                    edit.apply();
                    
                    //初始化红包用户信息
                    RPContext.getInstance().initUserInfo(user.getResult().getId(), user.getResult().getUsername(),
                                                         user.getResult().getPortrait());
                                                         
                    Log.i(TAG, "----login success---");
                }
            } else if (user.getCode() == 103) {

                if (mDialog != null)
                    mDialog.dismiss();

                WinToast.toast(LoginActivity.this, R.string.app_pass_error);
            } else if (user.getCode() == 104) {

                if (mDialog != null)
                    mDialog.dismiss();

                WinToast.toast(LoginActivity.this, R.string.app_user_error);
            } else if (user.getCode() == 111) {
                if (mDialog != null)
                    mDialog.dismiss();
                WinToast.toast(LoginActivity.this, R.string.app_user_cookie);
            }
        }
    }
    
```
* LoginActivity快速登录时初始化用户信息。

```
    import com.easemob.redpacketui.RPContext;
        
     protected void initData() {
     
       ...
      
    if (!token.equals(Constants.DEFAULT) && !cookie.equals(Constants.DEFAULT)) {

       if (mDialog != null && !mDialog.isShowing()) {
                    mDialog.show();
             }

     //初始化红包用户信息
     String userID = PreferenceManager.getDefaultSharedPreferences(this).getString(
     Constants.APP_USER_ID, "default");
     String userName = PreferenceManager.getDefaultSharedPreferences(this).getString(
     Constants.APP_USER_NAME,"default");
     String userAvatar = PreferenceManager.getDefaultSharedPreferences(this).getString(
     Constants.APP_USER_PORTRAIT, "none");
     
     RPContext.getInstance().initUserInfo(userID, userName, userAvatar);

     httpGetTokenSuccess(token);
            
        }
    }
    
```

### 3.5 RongCloudEvent中、在扩展栏中增加红包按钮
* 需要导入的包

```
    import com.easemob.redpacketui.provider.RongGroupRedPacketProvider;
    import com.easemob.redpacketui.provider.RongRedPacketProvider;
```

* 添加单聊红包入口

```

    InputProvider.ExtendProvider[] privateProvider = {
                new ImageInputProvider(RongContext.getInstance()),//图片
                new CameraInputProvider(RongContext.getInstance()),//相机
                new RealTimeLocationInputProvider(RongContext.getInstance()),//地理位置
                new VoIPInputProvider(RongContext.getInstance()),// 语音通话
                new RongRedPacketProvider(RongContext.getInstance())//单聊红包
        };
    RongIM.resetInputExtensionProvider(Conversation.ConversationType.PRIVATE,  privateProvider); 
     
```


* 添加群聊红包入口

```

    InputProvider.ExtendProvider[] groupProvider = {
          new ImageInputProvider(RongContext.getInstance()),//图片
          new CameraInputProvider(RongContext.getInstance()),//相机
          new RealTimeLocationInputProvider(RongContext.getInstance()),//地理位置
          new ContactsProvider(RongContext.getInstance()),//通讯录
          new RongGroupRedPacketProvider(RongContext.getInstance(), new GetGroupInfoCallback() {
          //获取群组信息,并回调把群里面人数给回调接口
          @Override
          public void getGroupPersonNumber(final String groupID, final ToRedPacketActivity mCallback) {
           if (DemoContext.getInstance().getGroupNumberById(groupID) != null) {
              //这里的缓存群组信息的逻辑仅供参考
              int number = Integer.parseInt(DemoContext.getInstance().getGroupNumberById(groupID));
               mCallback.toRedPacketActivity(number);
              } else {
                DemoContext.getInstance().getDemoApi().getGroupByGroupId(groupID, new ApiCallback<GroupInfo>() {
                         
                  @Override
                  public void onComplete(AbstractHttpRequest<GroupInfo> abstractHttpRequest, GroupInfo groupInfo){
                         if (groupInfo.getCode() == 200 && groupInfo.getResult() != null) {
                            Log.e(TAG, groupInfo.getResult().getNumber());
                            int number = Integer.parseInt(groupInfo.getResult().getNumber());
                            //缓存群人数
                            if (DemoContext.getInstance() != null)
                               DemoContext.getInstance().putGroupNmber(groupID, String.valueOf(number));
                               //打开发红包界面
                               mCallback.toRedPacketActivity(number);
                               
                              } else {
                                      WinToast.toast(mContext, String.valueOf(groupInfo.getCode()));
                                    }
                                }

                            @Override
                            public void onFailure(AbstractHttpRequest abstractHttpRequest, BaseException e) {
                                    
                                    Log.e(TAG, e.toString());
                                }
                            });
                        }
                    }

                })//群红包
        }; 
         
    RongIM.resetInputExtensionProvider(Conversation.ConversationType.GROUP, groupProvider);
              
```    

* 添加讨论组红包入口


```

     InputProvider.ExtendProvider[] discussionProvider = {//讨论组
     new ImageInputProvider(RongContext.getInstance()),//图片
     new CameraInputProvider(RongContext.getInstance()),//相机
     new RealTimeLocationInputProvider(RongContext.getInstance()),//地理位置
     new ContactsProvider(RongContext.getInstance()),//通讯录
     new RongGroupRedPacketProvider(RongContext.getInstance(), new GetGroupInfoCallback() {
     //获取群组信息,并回调把群里面人数给回调接口
     @Override
     public void getGroupPersonNumber(final String groupID, final ToRedPacketActivity mCallback) {
     RongIM.getInstance().getRongIMClient().getDiscussion(groupID, new RongIMClient.ResultCallback<Discussion>() {
                            
           @Override
           public void onSuccess(Discussion discussion) {
                 //打开发红包界面
                 mCallback.toRedPacketActivity(discussion.getMemberIdList().size());
              }

           @Override
           public void onError(RongIMClient.ErrorCode errorCode) {

             }
        });

      }

    })//讨论组红包
    };  
              
    RongIM.resetInputExtensionProvider(Conversation.ConversationType.DISCUSSION, discussionProvider);

```

###3.6 添加零钱页的入口

* 在需要添加零钱的页面调用下面的方法


```
    import com.easemob.redpacketui.RPContext;

    RPContext.getInstance().toChangeActivity(this);

```
**以上集成完毕、以下关于红包的收发注解**
###3.7 关于群红包（讨论组红包）和单聊红包的发送


* RongRedPacketProvider中进入单聊红包界面

```
    import com.easemob.redpacketsdk.bean.RedPacketInfo;
    import com.easemob.redpacketsdk.constant.RPConstant;
    import com.easemob.redpacketui.R;
    import com.easemob.redpacketui.RPContext;
    import com.easemob.redpacketui.message.RongRedPacketMessage;
    import com.easemob.redpacketui.ui.activity.RPRedPacketActivity;
    
    //点击扩展栏红包按钮进入发送单聊红包界面
    @Override
    public void onPluginClick(View view) {
        final Intent intent = new Intent(mContext, RPRedPacketActivity.class);
        final RedPacketInfo redPacketInfo = new RedPacketInfo();
        redPacketInfo.fromAvatarUrl = RPContext.getInstance().getUserAvatar();//发送者头像
        redPacketInfo.fromNickName = RPContext.getInstance().getUserName();//发送者名字
        redPacketInfo.toUserId = getCurrentConversation().getTargetId(); //接受者id
        redPacketInfo.chatType = RPConstant.CHATTYPE_SINGLE;//单聊
        
        intent.putExtra(RPConstant.EXTRA_MONEY_INFO, redPacketInfo);
        startActivityForResult(intent, RPContext.REQUEST_CODE_SEND_MONEY);
    }
    
    @Override
    public void onActivityResult(int requestCode, int resultCode, Intent data) {
        
      //接受返回的红包信息,并发送红包消息
      if (resultCode == Activity.RESULT_OK && data != null && requestCode == RPContext.REQUEST_CODE_SEND_MONEY) {
            String greeting = data.getStringExtra(RPConstant.EXTRA_MONEY_GREETING);//祝福语
            String moneyID = data.getStringExtra(RPConstant.EXTRA_CHECK_MONEY_ID);//红包ID
            String userId = RPContext.getInstance().getUserID();//发送者ID
            String userName = RPContext.getInstance().getUserName();//发送者名字
            RongRedPacketMessage message = RongRedPacketMessage.obtain(userId, userName, greeting, moneyID,
            "1", "融云红包");       
            
            //发送红包消息到聊天界面
            mUploadHandler.post(new MyRunnable(message));
        }
    }
    
      class MyRunnable implements Runnable {

        RongRedPacketMessage mMessage;

        public MyRunnable(RongRedPacketMessage message) {
            mMessage = message;
        }

        @Override
        public void run() {
          if (RongIM.getInstance() != null && RongIM.getInstance().getRongIMClient() != null) {

            RongIM.getInstance().getRongIMClient().sendMessage(getCurrentConversation().getConversationType(),
            getCurrentConversation().getTargetId(), mMessage, null, null, new RongIMClient.SendMessageCallback() {
                   @Override
                   public void onError(Integer integer, RongIMClient.ErrorCode errorCode) {
                       Log.e("RedPacketProvider", "-----onError--" + errorCode);
                   }

                   @Override
                   public void onSuccess(Integer integer) {
                       Log.e("RedPacketProvider", "-----onSuccess--" + integer);
                   }
               },null);
           }

       }
    }  
      
```
* RongGroupRedPacketProvider中进入群红包（讨论组）界面

```

    //点击扩展栏红包按钮进入发送群（讨论组）红包界面 
    @Override
    public void onPluginClick(View view) {

        redPacketInfo = new RedPacketInfo();
        redPacketInfo.fromAvatarUrl = RPContext.getInstance().getUserAvatar(); //发送者头像url
        redPacketInfo.fromNickName = RPContext.getInstance().getUserName();//发送者昵称 设置了昵称就传昵称 否则传id
        redPacketInfo.toGroupId = getCurrentConversation().getTargetId();//群ID
        redPacketInfo.chatType = RPConstant.CHATTYPE_GROUP;//群聊、讨论组类型
        if (callback != null) {
            callback.getGroupPersonNumber(redPacketInfo.toGroupId,this);
        } else {
            Toast.makeText(mContext, "回调函数不能为空", Toast.LENGTH_SHORT).show();
        }


    }
    
    @Override
    public void toRedPacketActivity(int number) {
        Intent intent = new Intent(mContext, RPRedPacketActivity.class);
        redPacketInfo.groupMemberCount = number;
        intent.putExtra(RPConstant.EXTRA_MONEY_INFO, redPacketInfo);
        startActivityForResult(intent, RPContext.REQUEST_CODE_SEND_MONEY);
    }

    @Override
    public void onActivityResult(int requestCode, int resultCode, Intent data) {

        if (resultCode != Activity.RESULT_OK)
            return;
        //接受返回的红包信息,并发送红包消息
        if (data != null && requestCode == RPContext.REQUEST_CODE_SEND_MONEY) {
            String greeting = data.getStringExtra(RPConstant.EXTRA_MONEY_GREETING);//祝福语
            String moneyID = data.getStringExtra(RPConstant.EXTRA_CHECK_MONEY_ID);//红包ID
            String userId = RPContext.getInstance().getUserID();//发送者ID
            String userName = RPContext.getInstance().getUserName();//发送者名字
            RongRedPacketMessage message = RongRedPacketMessage.obtain(userId, userName, greeting, 
            moneyID,"1","融云红包");
           
            //发送红包消息到聊天界面            
            mUploadHandler.post(new MyRunnable(message));
        }

        super.onActivityResult(requestCode, resultCode, data);
    }
    
    class MyRunnable implements Runnable {

        RongRedPacketMessage mMessage;

        public MyRunnable(RongRedPacketMessage message) {
            mMessage = message;
        }

        @Override
        public void run() {
            if (RongIM.getInstance() != null && RongIM.getInstance().getRongIMClient() != null) {            

       RongIM.getInstance().getRongIMClient().sendMessage(getCurrentConversation().getConversationType(),
       getCurrentConversation().getTargetId() , mMessage, null, null, new RongIMClient.SendMessageCallback() {
                    @Override
                    public void onError(Integer integer, RongIMClient.ErrorCode errorCode) {
                        Log.e("PacketProvider", "-----onError--" + errorCode);
                    }

                    @Override
                    public void onSuccess(Integer integer) {
                        Log.e("PacketProvider", "-----onSuccess--" + integer);
                    }
                },null);
            }

        }
    }    
    
```

###3.8 RongRedPacketMessageProvider中打开红包消息和回执消息处理

* 接受红包消息打开红包

```

    @Override
    public void onItemClick(View view, int position, final RongRedPacketMessage content, final UIMessage message) 
    {
        final ProgressDialog progressDialog = new ProgressDialog(mContext);
        //进度条风格开发者可以根据需求改变
        progressDialog.setProgressStyle(ProgressDialog.STYLE_SPINNER);
        progressDialog.setCanceledOnTouchOutside(false);
        
        RedPacketInfo packetInfo = new RedPacketInfo();
        packetInfo.moneyID = content.getMoneyID();  //获取红包id
        //获取名字和头像url
        packetInfo.toAvatarUrl = RPContext.getInstance().getUserAvatar();
        packetInfo.toNickName = RPContext.getInstance().getUserName();
        //判断发送方还是接收方
        if (message.getMessageDirection() == UIMessage.MessageDirection.SEND) {
            packetInfo.moneyMsgDirect = RPConstant.MESSAGE_DIRECT_SEND;
        } else {
            packetInfo.moneyMsgDirect = RPConstant.MESSAGE_DIRECT_RECEIVE;
        }
        //获取聊天类型/单聊群聊
        if (message.getConversationType() == Conversation.ConversationType.PRIVATE) {//单聊
            packetInfo.chatType = RPConstant.CHATTYPE_SINGLE;
        } else {//群聊
            packetInfo.chatType = RPConstant.CHATTYPE_GROUP;
        }
    RPOpenPacketUtil.getInstance().openRedPacket(packetInfo, (FragmentActivity) mContext, 
                new RPOpenPacketUtil.RPOpenPacketCallBack() {
            @Override
            public void onSuccess(String s, String s1) {
                //打开红包消息成功,然后发送回执消息例如"你领取了XX的红包"
                sendAckMsg(content, message, RPContext.getInstance().getUserName());
            }

            @Override
            public void showLoading() {
                progressDialog.show();

            }

            @Override
            public void hideLoading() {
                progressDialog.dismiss();
            }

            @Override
            public void onError(String s, String s1) {
                //错误处理
                Toast.makeText(mContext, s, Toast.LENGTH_SHORT).show();
            }
        }); 
     }
    
```
* 接受红包消息之后回执消息的处理

```

     public void sendAckMsg(RongRedPacketMessage content, UIMessage message, String receiveName) {
        String receiveID = RPContext.getInstance().getUserID();
        RongNotificationMessage rongNotificationMessage = RongNotificationMessage.obtain(content.getSendUserID(), 
                content.getSendUserName(), receiveID, receiveName, "1");//回执消息
        final RongEmptyMessage rongEmptyMessage = RongEmptyMessage.obtain(content.getSendUserID(),
                content.getSendUserName(), receiveID, receiveName, "1");//空消息
        if (message.getConversationType() == Conversation.ConversationType.PRIVATE) {//单聊
            RongIM.getInstance().getRongIMClient().sendMessage(message.getConversationType(), 
            content.getSendUserID(), rongNotificationMessage, null, null, new RongIMClient.SendMessageCallback() {
                @Override
                public void onError(Integer integer, RongIMClient.ErrorCode errorCode) {
                    Log.e("yzh", "-单聊发送回执消息失败-");

                }

                @Override
                public void onSuccess(Integer integer) {

                    Log.e("yzh", "-单聊发送回执消息成功-");
                }
            }, null);
        } else {//群聊讨论组
            if (content.getSendUserID().equals(receiveID)) {//自己领取了自己的红包
                RongIM.getInstance().getRongIMClient().insertMessage(message.getConversationType(),
                        message.getTargetId(), receiveID, rongNotificationMessage, null);
            } else {
                RongIM.getInstance().getRongIMClient().sendMessage(message.getConversationType(),
                message.getTargetId(), rongEmptyMessage, null, null, new RongIMClient.SendMessageCallback() {
                    @Override
                    public void onError(Integer integer, RongIMClient.ErrorCode errorCode) {
                        Log.e("yzh", "-发送空消息通知类失败-");

                    }

                    @Override
                    public void onSuccess(Integer integer) {

                        Log.e("yzh", "-发送空消息通知类成功-");
                    }
                }, null);
                RongIM.getInstance().getRongIMClient().insertMessage(message.getConversationType(),
                        message.getTargetId(), receiveID, rongNotificationMessage, null);
            }
        }
    }
    
``` 
*红包消息删除处理

```

    @Override
    public void onItemLongClick(View view, int position, RongRedPacketMessage content, final UIMessage message) {

        String[] items;
        items = new String[]{view.getContext().getResources().getString(R.string.yzh_dialog_item_delete)};
        ArraysDialogFragment.newInstance("", items).setArraysDialogItemListener(
                new ArraysDialogFragment.OnArraysDialogItemListener() {
            @Override
            public void OnArraysDialogItemClick(DialogInterface dialog, int which) {
                if (which == 0)
                RongIM.getInstance().getRongIMClient().deleteMessages(new int[]{message.getMessageId()}, null);

            }
        }).show(((FragmentActivity) view.getContext()).getSupportFragmentManager());
    }
    
```






